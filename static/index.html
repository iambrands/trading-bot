<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradePilot Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000000;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
        }

        .status-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .status-running {
            background: #10b981;
            color: white;
        }

        .status-paused {
            background: #f59e0b;
            color: white;
        }

        .status-stopped {
            background: #ef4444;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #6b7280;
        }

        .metric-value {
            font-weight: bold;
            color: #111827;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .btn-start {
            background: #10b981;
            color: white;
        }

        .btn-pause {
            background: #f59e0b;
            color: white;
        }

        .btn-resume {
            background: #3b82f6;
            color: white;
        }

        .btn-stop {
            background: #6b7280;
            color: white;
        }

        .btn-kill {
            background: #ef4444;
            color: white;
        }

        .btn-close-all {
            background: #f97316;
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .positions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .positions-table th,
        .positions-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .positions-table th {
            background: #f9fafb;
            font-weight: bold;
            color: #667eea;
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .trades-table th,
        .trades-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9em;
        }

        .trades-table th {
            background: #f9fafb;
            font-weight: bold;
            color: #667eea;
            position: sticky;
            top: 0;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85em;
            color: #6b7280;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ü§ñ TradePilot Dashboard</h1>
                <p style="color: #6b7280; margin-top: 5px;">Real-time Trading Platform Monitoring</p>
            </div>
            <div>
                <span id="statusBadge" class="status-badge status-stopped">Loading...</span>
                <div style="margin-top: 10px; font-size: 0.85em; color: #6b7280;">
                    <span id="lastUpdate">Never</span>
                </div>
            </div>
        </div>

        <div class="refresh-indicator">
            <span id="refreshStatus">üîÑ Auto-refreshing every 5s</span>
        </div>

        <div class="control-panel">
            <h2>Control Panel</h2>
            <div class="buttons">
                <button class="btn-start" onclick="controlBot('start')">‚ñ∂ Start</button>
                <button class="btn-pause" onclick="controlBot('pause')">‚è∏ Pause</button>
                <button class="btn-resume" onclick="controlBot('resume')">‚ñ∂ Resume</button>
                <button class="btn-stop" onclick="controlBot('stop')">‚èπ Stop</button>
                <button class="btn-close-all" onclick="controlBot('close-all')">‚úï Close All Positions</button>
                <button class="btn-kill" onclick="if(confirm('Are you sure? This will immediately stop the bot and close all positions.')) controlBot('kill-switch')">üö® Kill Switch</button>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Account Status</h2>
                <div id="accountStatus" class="loading">Loading...</div>
            </div>

            <div class="card">
                <h2>Performance Metrics</h2>
                <div id="performanceMetrics" class="loading">Loading...</div>
            </div>

            <div class="card">
                <h2>Risk Metrics</h2>
                <div id="riskMetrics" class="loading">Loading...</div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 20px;">
            <h2>Active Positions</h2>
            <div id="positions" class="loading">Loading...</div>
        </div>

        <div class="card">
            <h2>Recent Trades</h2>
            <div id="trades" class="loading">Loading...</div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';  // Relative path - works on any port
        let refreshInterval;

        async function fetchAPI(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                return null;
            }
        }

        async function controlBot(action) {
            try {
                const response = await fetch(`${API_BASE}/${action}`, { method: 'POST' });
                const result = await response.json();
                alert(result.message || 'Action completed');
                updateDashboard();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        }

        function formatPercent(value) {
            return `${value >= 0 ? '+' : ''}${value.toFixed(2)}%`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString();
        }

        function updateStatusBadge(status) {
            const badge = document.getElementById('statusBadge');
            badge.textContent = status.toUpperCase();
            badge.className = `status-badge status-${status.toLowerCase()}`;
        }

        async function updateStatus() {
            const data = await fetchAPI('/status');
            if (!data) return;

            updateStatusBadge(data.status);
            document.getElementById('accountStatus').innerHTML = `
                <div class="metric">
                    <span class="metric-label">Balance</span>
                    <span class="metric-value">${formatCurrency(data.balance)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Positions</span>
                    <span class="metric-value">${data.positions_count}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Mode</span>
                    <span class="metric-value">${data.paper_trading ? 'üìù Paper Trading' : 'üí∞ Live Trading'}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Environment</span>
                    <span class="metric-value">${data.environment}</span>
                </div>
            `;
        }

        async function updatePerformance() {
            const data = await fetchAPI('/performance');
            if (!data) return;

            document.getElementById('performanceMetrics').innerHTML = `
                <div class="metric">
                    <span class="metric-label">Total P&L</span>
                    <span class="metric-value ${data.total_pnl >= 0 ? 'positive' : 'negative'}">
                        ${formatCurrency(data.total_pnl)}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Daily P&L</span>
                    <span class="metric-value ${data.daily_pnl >= 0 ? 'positive' : 'negative'}">
                        ${formatCurrency(data.daily_pnl)}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">ROI</span>
                    <span class="metric-value ${data.roi_pct >= 0 ? 'positive' : 'negative'}">
                        ${formatPercent(data.roi_pct)}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Win Rate</span>
                    <span class="metric-value">${data.win_rate.toFixed(2)}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Trades</span>
                    <span class="metric-value">${data.total_trades}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Profit Factor</span>
                    <span class="metric-value">${data.profit_factor.toFixed(2)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Sharpe Ratio</span>
                    <span class="metric-value">${data.sharpe_ratio.toFixed(2)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Max Drawdown</span>
                    <span class="metric-value">${formatPercent(data.max_drawdown)}</span>
                </div>
            `;
        }

        async function updateRisk() {
            const data = await fetchAPI('/risk');
            if (!data) return;

            document.getElementById('riskMetrics').innerHTML = `
                <div class="metric">
                    <span class="metric-label">Total Exposure</span>
                    <span class="metric-value">${formatCurrency(data.total_exposure)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Exposure %</span>
                    <span class="metric-value">${data.total_exposure_pct.toFixed(2)}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Risk Exposure</span>
                    <span class="metric-value">${formatCurrency(data.risk_exposure)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Daily P&L</span>
                    <span class="metric-value ${data.daily_pnl >= 0 ? 'positive' : 'negative'}">
                        ${formatCurrency(data.daily_pnl)}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Remaining Capacity</span>
                    <span class="metric-value">${formatCurrency(data.remaining_daily_capacity)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Open Positions</span>
                    <span class="metric-value">${data.open_positions} / ${data.max_positions}</span>
                </div>
                ${data.daily_loss_limit_reached ? `
                <div class="error">
                    ‚ö†Ô∏è Daily loss limit reached!
                </div>
                ` : ''}
            `;
        }

        async function updatePositions() {
            const data = await fetchAPI('/positions');
            if (!data || !data.positions) return;

            if (data.positions.length === 0) {
                document.getElementById('positions').innerHTML = `
                    <div class="empty-state">No active positions</div>
                `;
                return;
            }

            let html = '<table class="positions-table"><thead><tr>';
            html += '<th>Pair</th><th>Side</th><th>Size</th><th>Entry Price</th><th>Current Price</th>';
            html += '<th>Stop Loss</th><th>Take Profit</th><th>P&L</th><th>P&L %</th></tr></thead><tbody>';

            data.positions.forEach(pos => {
                html += '<tr>';
                html += `<td><strong>${pos.pair}</strong></td>`;
                html += `<td><span style="color: ${pos.side === 'LONG' ? '#10b981' : '#ef4444'}">${pos.side}</span></td>`;
                html += `<td>${parseFloat(pos.size).toFixed(6)}</td>`;
                html += `<td>${formatCurrency(pos.entry_price)}</td>`;
                html += `<td>${formatCurrency(pos.current_price)}</td>`;
                html += `<td>${formatCurrency(pos.stop_loss)}</td>`;
                html += `<td>${formatCurrency(pos.take_profit)}</td>`;
                html += `<td class="${pos.current_pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pos.current_pnl)}</td>`;
                html += `<td class="${pos.current_pnl_pct >= 0 ? 'positive' : 'negative'}">${formatPercent(pos.current_pnl_pct)}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            document.getElementById('positions').innerHTML = html;
        }

        async function updateTrades() {
            const data = await fetchAPI('/trades?limit=20');
            if (!data || !data.trades) return;

            if (data.trades.length === 0) {
                document.getElementById('trades').innerHTML = `
                    <div class="empty-state">No trades yet</div>
                `;
                return;
            }

            let html = '<table class="trades-table"><thead><tr>';
            html += '<th>Time</th><th>Pair</th><th>Side</th><th>Entry</th><th>Exit</th>';
            html += '<th>Size</th><th>P&L</th><th>P&L %</th><th>Reason</th></tr></thead><tbody>';

            data.trades.slice(0, 20).forEach(trade => {
                html += '<tr>';
                html += `<td>${formatDate(trade.entry_time)}</td>`;
                html += `<td><strong>${trade.pair}</strong></td>`;
                html += `<td><span style="color: ${trade.side === 'LONG' ? '#10b981' : '#ef4444'}">${trade.side}</span></td>`;
                html += `<td>${formatCurrency(parseFloat(trade.entry_price))}</td>`;
                html += `<td>${trade.exit_price ? formatCurrency(parseFloat(trade.exit_price)) : '-'}</td>`;
                html += `<td>${parseFloat(trade.size).toFixed(6)}</td>`;
                const pnl = parseFloat(trade.pnl || 0);
                const pnlPct = parseFloat(trade.pnl_pct || 0);
                html += `<td class="${pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pnl)}</td>`;
                html += `<td class="${pnlPct >= 0 ? 'positive' : 'negative'}">${formatPercent(pnlPct)}</td>`;
                html += `<td>${trade.exit_reason || '-'}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            document.getElementById('trades').innerHTML = html;
        }

        async function updateDashboard() {
            await Promise.all([
                updateStatus(),
                updatePerformance(),
                updateRisk(),
                updatePositions(),
                updateTrades()
            ]);

            document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        // Initial load
        updateDashboard();

        // Auto-refresh every 5 seconds
        refreshInterval = setInterval(updateDashboard, 5000);

        // Update refresh indicator
        setInterval(() => {
            const now = new Date();
            document.getElementById('refreshStatus').textContent = 
                `üîÑ Last refresh: ${now.toLocaleTimeString()}`;
        }, 1000);
    </script>
</body>
</html>
